<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Download Media Tabs – Options</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="options.css" />
</head>
<body>
<!-- Header -->
<header class="appbar">
    <div class="logo" aria-hidden="true">
        <img src="../icons/icon.svg" alt="Extension logo">
    </div>
    <div class="title">
        <h1>Download Media Tabs</h1>
        <span class="subtitle">Options</span>
    </div>
    <div style="margin-left:auto; display:flex; align-items:center; gap:8px">
        <button id="reset" type="button" title="Reset all settings to defaults">Defaults</button>
        <button id="save" type="button" class="primary" disabled>Save</button>
    </div>
</header>

<main class="shell">
    <div class="tabs" role="application">
        <!-- Tab headers -->
        <div class="tablist" role="tablist" aria-label="Settings tabs">
            <button class="tabbtn" role="tab" id="tab-general"     aria-controls="panel-general"     aria-selected="true"  tabindex="0">General</button>
            <button class="tabbtn" role="tab" id="tab-automation" aria-controls="panel-automation" aria-selected="false" tabindex="-1">Automation</button>
            <button class="tabbtn" role="tab" id="tab-detection"   aria-controls="panel-detection"   aria-selected="false" tabindex="-1">Detection</button>
            <button class="tabbtn" role="tab" id="tab-performance" aria-controls="panel-performance" aria-selected="false" tabindex="-1">Performance</button>
            <button class="tabbtn" role="tab" id="tab-theme"       aria-controls="panel-theme"       aria-selected="false" tabindex="-1">Theme</button>
            <button class="tabbtn" role="tab" id="tab-presets"     aria-controls="panel-presets"     aria-selected="false" tabindex="-1">Presets</button>
            <button class="tabbtn" role="tab" id="tab-about"       aria-controls="panel-about"       aria-selected="false" tabindex="-1">About</button>
        </div>

        <!-- Panels -->
        <div class="panels">
            <!-- General -->
            <section class="panel" id="panel-general" role="tabpanel" aria-labelledby="tab-general">
                <fieldset>
                    <legend>How to use</legend>
                    <p>Click the toolbar button to run with your configured default scope.</p>
                    <p>Right‑click the extension toolbar icon to open quick actions and scope options.</p>
                    <p class="note">To reopen this Options page later: right‑click the extension toolbar icon and choose <em>Options</em>. You can also open the extension’s Details page in <span class="kbd">chrome://extensions</span> and click <em>Extension options</em>.</p>
                    <p class="warning"><strong>Warning:</strong> For silent bulk downloads, disable <em>Ask where to save each file before downloading</em> at <span class="kbd">chrome://settings/downloads</span>. Otherwise Chrome will show a Save dialog for every file.</p>
                </fieldset>
                <fieldset>
                    <legend>Scope &amp; naming</legend>
                    <div class="row">
                        <label>Default scope
                            <select id="scope">
                                <option value="currentWindow">Current window</option>
                                <option value="allWindows">All windows</option>
                                <option value="selectedTabs">Selected tabs (current window)</option>
                                <option value="currentGroup">Current tab group</option>
                                <option value="leftOfActive">Tabs to the left (including current tab)</option>
                                <option value="rightOfActive">Tabs to the right (including current tab)</option>
                            </select>
                        </label>
                    </div>
                    <label>Filename pattern
                        <input id="filenamePattern" type="text" placeholder="Media Tabs/{YYYYMMDD-HHmmss}/{host}/{basename}">
                    </label>
                    <p id="patternPreview" class="note"></p>
                    <p class="note">
                        Variables: <span class="kbd">{YYYYMMDD-HHmmss}</span>, <span class="kbd">{host}</span>, <span class="kbd">{basename}</span>.
                        Extension inferred when absent.
                    </p>
                </fieldset>

                <fieldset>
                    <legend>Filters</legend>
                    <section id="fs-media" role="group" aria-labelledby="media-types-heading">
                        <h3 class="h3" id="media-types-heading">Media types</h3>
                        <div class="media-grid">
                            <div class="media-toggle">
                                <input type="checkbox" id="includeImages" />
                                <label for="includeImages">
                                    <span class="icon" aria-hidden="true">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
                                        </svg>
                                    </span>
                                    <span class="text">
                                        <span class="title">Images</span>
                                        <span class="caption">image/*</span>
                                    </span>
                                </label>
                            </div>
                            <div class="media-toggle">
                                <input type="checkbox" id="includeVideo" />
                                <label for="includeVideo">
                                    <span class="icon" aria-hidden="true">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="m15.75 10.5 4.72-4.72a.75.75 0 0 1 1.28.53v11.38a.75.75 0 0 1-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25h-9A2.25 2.25 0 0 0 2.25 7.5v9a2.25 2.25 0 0 0 2.25 2.25Z" />
                                        </svg>
                                    </span>
                                    <span class="text">
                                        <span class="title">Video</span>
                                        <span class="caption">video/*</span>
                                    </span>
                                </label>
                            </div>
                            <div class="media-toggle">
                                <input type="checkbox" id="includeAudio" />
                                <label for="includeAudio">
                                    <span class="icon" aria-hidden="true">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 0 1 0 12.728M16.463 8.288a5.25 5.25 0 0 1 0 7.424M6.75 8.25l4.72-4.72a.75.75 0 0 1 1.28.53v15.88a.75.75 0 0 1-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.009 9.009 0 0 1 2.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75Z" />
                                        </svg>
                                    </span>
                                    <span class="text">
                                        <span class="title">Audio</span>
                                        <span class="caption">audio/*</span>
                                    </span>
                                </label>
                            </div>
                            <div class="media-toggle">
                                <input type="checkbox" id="includePdf" />
                                <label for="includePdf">
                                    <span class="icon" aria-hidden="true">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                                        </svg>
                                    </span>
                                    <span class="text">
                                        <span class="title">PDF</span>
                                        <span class="caption">application/pdf</span>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </section>

                    <section id="fs-enable-filters">
                        <h3 class="h3">Enable advanced filters</h3>
                        <label class="inline">
                            <input type="checkbox" id="filtersEnabled">
                            Enable advanced filters (size, dimensions, domain, extension, MIME, URL)
                        </label>
                        <p class="note">
                            Media type selection above is always applied. Advanced filters can be turned on/off with the switch.
                        </p>
                    </section>
                    <section id="fs-size-dimensions">
                        <h3 class="h3">Image dimensions</h3>
                        <div class="grid2">
                            <label>Minimum width (px)
                                <input id="minWidth" type="number" min="0" step="1" />
                            </label>
                            <label>Minimum height (px)
                                <input id="minHeight" type="number" min="0" step="1" />
                            </label>
                        </div>
                        <div class="grid2">
                            <label>Maximum width (px)
                                <input id="maxWidth" type="number" min="0" step="1" />
                            </label>
                            <label>Maximum height (px)
                                <input id="maxHeight" type="number" min="0" step="1" />
                            </label>
                        </div>
                        <div class="grid2">
                            <label>Minimum megapixels (MP)
                                <input id="minMegapixels" type="number" min="0" step="0.1" />
                            </label>
                            <label>Maximum megapixels (MP)
                                <input id="maxMegapixels" type="number" min="0" step="0.1" />
                            </label>
                        </div>
                        <p class="note">Use 0 for “no limit”. Dimensions apply to images; other media types are unaffected.</p>
                    </section>

                    <section id="fs-size-bytes">
                        <h3 class="h3">File size (bytes)</h3>
                        <div class="grid2">
                            <div class="row">
                                <label>Minimum size
                                    <input id="minSizeValue" type="number" min="0" step="1" />
                                </label>
                                <label style="max-width:140px">Unit
                                    <select id="minSizeUnit">
                                        <option value="B">B</option>
                                        <option value="KB">KB</option>
                                        <option value="MB">MB</option>
                                        <option value="GB">GB</option>
                                    </select>
                                </label>
                            </div>
                            <div class="row">
                                <label>Maximum size
                                    <input id="maxSizeValue" type="number" min="0" step="1" />
                                </label>
                                <label style="max-width:140px">Unit
                                    <select id="maxSizeUnit">
                                        <option value="B">B</option>
                                        <option value="KB">KB</option>
                                        <option value="MB" selected>MB</option>
                                        <option value="GB">GB</option>
                                    </select>
                                </label>
                            </div>
                        </div>
                        <p class="note">Values are stored in bytes. Use 0 for “no limit”.</p>
                    </section>

                    <section id="fs-domain">
                        <h3 class="h3">Domain allow/deny</h3>
                        <div class="grid2">
                            <label>
                                <div class="label-row">
                                    <span>Allowed domains (one per line)</span>
                                </div>
                                <textarea id="allowedDomains" placeholder="example.com&#10;images.example.org"></textarea>
                            </label>
                            <label>Blocked domains (one per line)
                                <textarea id="blockedDomains" placeholder="ads.example.com&#10;tracking.example.net"></textarea>
                            </label>
                        </div>
                        <p class="note">Suffix match (e.g., “example.com” also matches “sub.example.com”).</p>
                    </section>

                    <section id="fs-ext-mime">
                        <h3 class="h3">Extension &amp; MIME</h3>
                        <div class="grid2">
                            <div>
                                <div class="label-row">
                                    <label class="label-text" for="allowedExtensions">Allowed extensions (one per line)</label>
                                </div>
                                <textarea id="allowedExtensions" placeholder="jpg&#10;png&#10;mp4"></textarea>
                            </div>
                            <label>Blocked extensions (one per line)
                                <textarea id="blockedExtensions" placeholder="gif&#10;svg"></textarea>
                            </label>
                        </div>
                        <div class="grid2">
                            <div>
                                <div class="label-row">
                                    <label class="label-text" for="allowedMime">Allowed MIME patterns (one per line)</label>
                                </div>
                                <textarea id="allowedMime" placeholder="image/*&#10;video/mp4"></textarea>
                            </div>
                            <label>Blocked MIME patterns (one per line)
                                <textarea id="blockedMime" placeholder="image/svg+xml"></textarea>
                            </label>
                        </div>
                        <p class="note">MIME supports wildcards like <span class="kbd">image/*</span>.</p>
                    </section>

                    <section id="fs-url">
                        <h3 class="h3">URL substring filters</h3>
                        <div class="grid2">
                            <label>
                                <div class="label-row">
                                    <span>Include if URL contains (one per line)</span>
                                </div>
                                <textarea id="includeUrlSubstrings" placeholder="/photos/&#10;?download=true"></textarea>
                            </label>
                            <label>Exclude if URL contains (one per line)
                                <textarea id="excludeUrlSubstrings" placeholder="/banner/&#10;/thumbs/"></textarea>
                            </label>
                        </div>
                    </section>
                </fieldset>
            </section>

            <!-- Automation -->
            <section class="panel" id="panel-automation" role="tabpanel" aria-labelledby="tab-automation" hidden>
                <fieldset>
                    <legend>Auto-run</legend>
                    <label class="inline"><input type="checkbox" id="autoRunOnNewTabs"> Auto-download on new tabs (download single-media tabs as they load)</label>
                    <p class="note">When enabled, as a new tab finishes loading, the extension will try to download it if it’s a direct single-media page. Respects all filters and post-actions.</p>
                </fieldset>
                <fieldset>
                    <legend>Post actions</legend>
                    <label><input type="checkbox" id="closeTabAfterDownload"> Close the tab after its file is downloaded</label>
                    <label><input type="checkbox" id="keepWindowOpenOnLastTabClose"> Keep window open if this would close its last tab</label>
                    <p class="note">
                        For silent bulk downloads, disable <em>Ask where to save each file before downloading</em> at
                        <span class="kbd">chrome://settings/downloads</span>.
                    </p>
                </fieldset>
            </section>

            <!-- Detection -->
            <section class="panel" id="panel-detection" role="tabpanel" aria-labelledby="tab-detection" hidden>
                <fieldset>
                    <legend>Single-media detection</legend>
                    <label><input type="checkbox" id="strictSingleDetection"> Strict single-media detection (recommended)</label>
                    <div class="row">
                        <label>Viewport coverage threshold
                            <input id="coverageThreshold" type="number" min="0" max="1" step="0.05" />
                        </label>
                    </div>
                    <p class="note">
                        In strict mode, a page qualifies only if it has exactly one media element, it is a direct child of <span class="kbd">&lt;body&gt;</span>,
                        and it covers the given fraction of the viewport.
                    </p>
                </fieldset>

                <fieldset>
                    <legend>URL hints</legend>
                    <p class="note">URL hints only help the extension <em>classify</em> a page as media when the URL is ambiguous (no extension or probing fails). They never force a download; the tab still has to pass normal media‑type checks and all filters.</p>
                    <label><input type="checkbox" id="inferExtensionFromUrl"> Infer media extension from URL hints</label>
                    <p class="note">When enabled, the extension tries to guess the media type from URL hints (query params like <span class="kbd">format=webp</span> or path tokens like <span class="kbd">-jpeg</span>) when there’s no file extension or probing can’t determine one.</p>
                    <div class="row">
                        <div>
                            <div class="label-row">
                                <label class="label-text" for="inferUrlAllowedExtensions">URL-hint allowed extensions (one per line)</label>
                                <button id="resetInferUrlAllowedExtensions" class="icon-btn" type="button" title="Reset URL-hint extensions to defaults" aria-label="Reset URL-hint extensions to defaults">↺</button>
                            </div>
                            <textarea id="inferUrlAllowedExtensions" placeholder="jpg&#10;png&#10;webp"></textarea>
                        </div>
                    </div>
                    <p class="note">Limits which extensions URL hints are allowed to resolve to. Remove items to disable them, or clear the list to disable hint-based guessing entirely.</p>
                </fieldset>

                <fieldset>
                    <legend>URL triggers</legend>
                    <p class="note">URL triggers <em>force</em> a download attempt when the URL contains one of your substrings. With bypass off, filters still apply (so the download can still be blocked). With bypass on, filters and media‑type checks are ignored.</p>
                    <div class="row">
                        <div>
                            <div class="label-row">
                                <label class="label-text" for="triggerUrlSubstrings">Download trigger URL substrings (one per line)</label>
                            </div>
                            <textarea id="triggerUrlSubstrings" placeholder=".keys&#10;/attachments/"></textarea>
                        </div>
                    </div>
                    <label class="inline"><input type="checkbox" id="triggerBypassFilters"> Triggers bypass filters and media-type checks</label>
                    <p class="note">Any match in the full URL triggers a download attempt. Use with care.</p>
                </fieldset>
            </section>

            <!-- Performance -->
            <section class="panel" id="panel-performance" role="tabpanel" aria-labelledby="tab-performance" hidden>
                <fieldset>
                    <legend>Parallelism</legend>
                    <div class="grid2">
                        <label>Probe concurrency (tabs)
                            <input id="probeConcurrency" type="number" min="1" max="32" step="1" />
                        </label>
                        <label>Download concurrency
                            <input id="downloadConcurrency" type="number" min="1" max="32" step="1" />
                        </label>
                    </div>
                    <p class="note">Higher values finish faster but can increase CPU/network load.</p>
                </fieldset>

                <fieldset>
                    <legend>Allow pre-fetching sites (optional)</legend>
                    <p class="note">Optional. Leaving this empty is fine, and downloads still work. If pre-checks aren’t allowed, size/type rules may be enforced after download.</p>
                    <label>Sites to allow for pre-checks (one Chrome match pattern per line)
                        <textarea id="allowedOrigins" placeholder="https://example.com/*&#10;*://*.example.org/*"></textarea>
                    </label>
                    <p class="note">
                        Why add sites: some hosts block cross-origin header reads. Granting access here lets the extension read Content-Length/Type before download and skip files that won’t meet your filters. Many CDNs already work without this. Add entries if you see CORS/pre-check failures or unknown size.
                    </p>
                    <p class="note">Use Chrome match patterns (e.g., https://example.com/*, *://*.example.org/*). Access is requested at runtime only for listed sites. All sites: *://*/*</p>
                    <div class="row">
                        <button id="requestHostPerms" type="button">Request permissions now</button>
                    </div>
                </fieldset>
            </section>

            <!-- Theme -->
            <section class="panel" id="panel-theme" role="tabpanel" aria-labelledby="tab-theme" hidden>
                <fieldset>
                    <legend>Theme</legend>
                    <label>Choose theme
                        <select id="theme">
                            <option value="system">System</option>
                            <option value="latte">Latte</option>
                            <option value="frappe">Frappe</option>
                            <option value="macchiato">Macchiato</option>
                            <option value="mocha">Mocha</option>
                        </select>
                    </label>
                    <p class="note">Theme controls the color scheme of this options page and popup UI. System uses your OS/browser preference.</p>
                </fieldset>
            </section>

            <!-- Saved configurations -->
            <section class="panel" id="panel-presets" role="tabpanel" aria-labelledby="tab-presets" hidden>
                <fieldset>
                    <legend>Presets</legend>
                    <div class="row">
                        <label><span class="label-text">Preset name</span>
                            <input id="presetName" type="text" placeholder="My preset" />
                        </label>
                        <button id="savePreset" type="button" title="Save current options as a preset">Save</button>
                    </div>
                    <div class="row" style="margin-top:8px">
                        <button id="exportSettings" type="button" title="Export current options to options.json" style="flex:0 0 auto">Export options</button>
                        <input id="importFile" type="file" accept="application/json,.json" style="display:none" />
                        <button id="importSettings" type="button" title="Import options from options.json" style="flex:0 0 auto">Import options</button>
                    </div>
                    <div>
                        <h3 class="h3">Saved presets</h3>
                        <div id="presetsEmpty" class="note">No presets yet. Create one with “Save preset”.</div>
                        <ul id="presetsList" style="list-style:none; padding:0; margin:8px 0; display:grid; gap:8px"></ul>
                    </div>
                </fieldset>
            </section>

            <!-- About -->
            <section class="panel" id="panel-about" role="tabpanel" aria-labelledby="tab-about" hidden>
                <fieldset>
                    <legend>About</legend>
                    <p><strong>Download Media Tabs</strong> finds downloadable media (images, video, audio, PDFs) across your open tabs and saves them for you. It can also close tabs after their download finishes to help you clean up.</p>
                    <p>I couldn’t find a simple Chromium extension that downloaded media from open tabs and closed them, so I built one and added features I hope others find useful.</p>
                    <ul>
                        <li>Adjust your scope: all windows, current window/tab group, tabs to the left/right.</li>
                        <li>Flexible filename patterns, e.g. <span class="kbd">Media Tabs/{YYYYMMDD-HHmmss}/{host}/{basename}</span>.</li>
                        <li>Filters: media types, size, image dimensions/megapixels, domain allow/deny, extensions, MIME patterns, and URL substrings.</li>
                        <li>Post-actions: close tabs after download; keep window open if it would close the last tab.</li>
                        <li>Tunable concurrency for faster bulk downloads.</li>
                    </ul>
                    <p><strong>Scope:</strong> This extension is designed exclusively for single‑media tabs — pages that display exactly one piece of content (for example, a direct image/video/audio/PDF URL). It does not crawl pages to discover assets and is <strong>not</strong> an image scraper.</p>
                    <p class="note">How to use: Click the toolbar button to run with your default scope. Or right‑click the toolbar icon for quick actions like “current window” or “all windows”.</p>
                    <p class="note">Privacy: All logic runs locally in your browser. The extension does not contact external services.</p>
                    <h3 class="h3">Current limitations</h3>
                    <ul>
                        <li>Downloads always start a new request. In theory an extension could try to reuse bytes already loaded in a tab, but CSP/CORS protections typically prevent that for cross‑origin content. We avoid hacky workarounds, so the same file may be fetched twice (once to display it, once to download it).</li>
                    </ul>
                </fieldset>
            </section>
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <span id="status" class="status" aria-live="polite"></span>
        </div>
    </div>
</main>

<!-- Toasts container -->
<div id="toasts" class="toasts" aria-live="polite" aria-atomic="true"></div>

<script type="module" src="options.js"></script>
</body>
</html>
